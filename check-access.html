<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É | –ü–æ—Å—ñ–±–Ω–∏–∫</title>
    <style>
        body {
            background: #0f172a;
            color: white;
            font-family: sans-serif;
            padding: 50px 20px;
            text-align: center;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #1e293b;
            padding: 40px;
            border-radius: 15px;
            border: 1px solid #334155;
        }
        
        h1 {
            color: #3B82F6;
            margin-bottom: 20px;
        }
        
        .status-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .pending {
            background: rgba(245, 158, 11, 0.2);
            border: 2px solid #F59E0B;
            color: #F59E0B;
        }
        
        .approved {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10B981;
            color: #10B981;
        }
        
        .rejected {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #EF4444;
            color: #EF4444;
        }
        
        .user-info {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .btn {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            font-size: 16px;
        }
        
        .admin-panel-btn {
            background: #8B5CF6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É</h1>
        
        <div class="user-info">
            <p><strong>ID:</strong> <span id="userId">...</span></p>
            <p><strong>–Ü–º'—è:</strong> <span id="userName">...</span></p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="userStatus">–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></p>
        </div>
        
        <div class="status-box pending" id="statusBox">
            <div id="statusText">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∞—à–æ–≥–æ –¥–æ—Å—Ç—É–ø—É...</div>
        </div>
        
        <div id="adminSection" style="display: none; margin-top: 30px;">
            <h3>üëë –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h3>
            <div id="pendingUsersList" style="margin: 20px 0;"></div>
        </div>
        
        <div style="margin-top: 30px;">
            <button class="btn" id="gotoManualBtn" style="display: none;">
                üìò –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–æ—Å—ñ–±–Ω–∏–∫–∞
            </button>
            <button class="btn admin-panel-btn" id="refreshBtn">
                üîÑ –û–Ω–æ–≤–∏—Ç–∏
            </button>
            <button class="btn" style="background: #64748B;" onclick="logout()">
                üö™ –í–∏–π—Ç–∏
            </button>
        </div>
    </div>
    
    <script type="module">
        import { db } from './firebase-app.js';
        import { 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc,
            collection,
            getDocs,
            query,
            orderBy 
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        
        // –¢–í–û–ô ID
        const ADMIN_ID = '5316593741';
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
        const userData = JSON.parse(localStorage.getItem('tg_user'));
        
        if (!userData) {
            window.location.href = 'login.html';
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        document.getElementById('userId').textContent = userData.id;
        document.getElementById('userName').textContent = userData.first_name;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
        async function checkAccess() {
            const userId = userData.id;
            
            // –ï—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω (–¢–´) - —Å—Ä–∞–∑—É –≤—Å—ë —Ä–∞–∑—Ä–µ—à–∞–µ–º
            if (userId === ADMIN_ID) {
                showAdminAccess();
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–µ
                const userDoc = await getDoc(doc(db, "users", userId));
                
                if (userDoc.exists()) {
                    const dbData = userDoc.data();
                    updateStatus(dbData.status);
                    
                    if (dbData.status === 'approved') {
                        showApproved();
                    }
                } else {
                    // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                    await setDoc(doc(db, "users", userId), {
                        telegram_id: userId,
                        name: userData.first_name,
                        username: userData.username || '',
                        status: 'pending',
                        created_at: new Date(),
                        last_login: new Date()
                    });
                    
                    updateStatus('pending');
                }
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                document.getElementById('statusText').innerHTML = '‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
            }
        }
        
        function showAdminAccess() {
            document.getElementById('userStatus').textContent = '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä';
            document.getElementById('statusText').innerHTML = '‚úÖ –í–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä!';
            document.getElementById('statusBox').className = 'status-box approved';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å—ñ–±–Ω–∏–∫–∞
            document.getElementById('gotoManualBtn').style.display = 'inline-block';
            document.getElementById('gotoManualBtn').onclick = () => {
                window.location.href = 'manual.html';
            };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            document.getElementById('adminSection').style.display = 'block';
            loadPendingUsers();
        }
        
        function showApproved() {
            document.getElementById('userStatus').textContent = '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ';
            document.getElementById('statusText').innerHTML = '‚úÖ –í–∞—à –¥–æ—Å—Ç—É–ø –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!';
            document.getElementById('statusBox').className = 'status-box approved';
            
            document.getElementById('gotoManualBtn').style.display = 'inline-block';
            document.getElementById('gotoManualBtn').onclick = () => {
                window.location.href = 'manual.html';
            };
        }
        
        function updateStatus(status) {
            document.getElementById('userStatus').textContent = 
                status === 'pending' ? '–û—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è' :
                status === 'approved' ? '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ' : '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ';
            
            if (status === 'pending') {
                document.getElementById('statusText').innerHTML = '‚è≥ –í–∞—à –∑–∞–ø–∏—Ç –Ω–∞ —Ä–æ–∑–≥–ª—è–¥—ñ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
                document.getElementById('statusBox').className = 'status-box pending';
            } else if (status === 'rejected') {
                document.getElementById('statusText').innerHTML = '‚ùå –í–∞—à –¥–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ';
                document.getElementById('statusBox').className = 'status-box rejected';
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–¥–º–∏–Ω–∞
        async function loadPendingUsers() {
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("created_at", "desc"));
                const querySnapshot = await getDocs(q);
                
                let pendingHtml = '';
                let approvedHtml = '';
                
                querySnapshot.forEach((docSnapshot) => {
                    const user = docSnapshot.data();
                    const userId = docSnapshot.id;
                    
                    if (userId === ADMIN_ID) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω–∞
                    
                    const userCard = `
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${user.name}</strong><br>
                                <small>ID: ${user.telegram_id} | @${user.username || '–±–µ–∑ –ª–æ–≥—ñ–Ω—É'}</small>
                            </div>
                            <div>
                                ${user.status === 'pending' ? `
                                    <button onclick="approveUser('${userId}')" style="background: #10B981; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 2px;">
                                        ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
                                    </button>
                                    <button onclick="rejectUser('${userId}')" style="background: #EF4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 2px;">
                                        ‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏
                                    </button>
                                ` : ''}
                                
                                ${user.status === 'approved' ? `
                                    <span style="color: #10B981;">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span>
                                    <button onclick="revokeUser('${userId}')" style="background: #F59E0B; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 2px;">
                                        üö´ –ó–∞–±—Ä–∞—Ç–∏ –¥–æ—Å—Ç—É–ø
                                    </button>
                                ` : ''}
                                
                                ${user.status === 'rejected' ? `
                                    <span style="color: #EF4444;">‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ</span>
                                    <button onclick="approveUser('${userId}')" style="background: #10B981; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 2px;">
                                        ‚úÖ –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–æ—Å—Ç—É–ø
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    if (user.status === 'pending') {
                        pendingHtml += userCard;
                    } else {
                        approvedHtml += userCard;
                    }
                });
                
                let finalHtml = '';
                
                if (pendingHtml) {
                    finalHtml += `<h4>‚è≥ –û—á—ñ–∫—É—é—Ç—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è:</h4>${pendingHtml}`;
                }
                
                if (approvedHtml) {
                    finalHtml += `<h4 style="margin-top: 30px;">üë§ –í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ:</h4>${approvedHtml}`;
                }
                
                if (!pendingHtml && !approvedHtml) {
                    finalHtml = '<p>–ù–µ–º–∞—î —ñ–Ω—à–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</p>';
                }
                
                document.getElementById('pendingUsersList').innerHTML = finalHtml;
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
                document.getElementById('pendingUsersList').innerHTML = '<p style="color: red;">‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
        window.approveUser = async function(userId) {
            try {
                await updateDoc(doc(db, "users", userId), {
                    status: 'approved',
                    approved_at: new Date()
                });
                alert('‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!');
                loadPendingUsers();
            } catch (error) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        };
        
        window.rejectUser = async function(userId) {
            if (!confirm('–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –¥–æ—Å—Ç—É–ø —Ü—å–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É?')) return;
            
            try {
                await updateDoc(doc(db, "users", userId), {
                    status: 'rejected',
                    rejected_at: new Date()
                });
                alert('‚úÖ –î–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ!');
                loadPendingUsers();
            } catch (error) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        };
        
        window.revokeUser = async function(userId) {
            if (!confirm('–ó–∞–±—Ä–∞—Ç–∏ –¥–æ—Å—Ç—É–ø —É —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) return;
            
            try {
                await updateDoc(doc(db, "users", userId), {
                    status: 'rejected',
                    revoked_at: new Date()
                });
                alert('‚úÖ –î–æ—Å—Ç—É–ø –∑–∞–±—Ä–∞–Ω–æ!');
                loadPendingUsers();
            } catch (error) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        };
        
        function logout() {
            localStorage.removeItem('tg_user');
            window.location.href = 'login.html';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        document.getElementById('refreshBtn').addEventListener('click', function() {
            location.reload();
        });
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º
        checkAccess();
    </script>
</body>
</html>
