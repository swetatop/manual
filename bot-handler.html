<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–æ–º | Ukraine GTA 5</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0C1016;
            color: white;
            font-family: sans-serif;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #0088cc; text-align: center; margin-bottom: 30px; }
        .back-btn {
            background: #2D3748;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: #1E293B;
        }
        .requests-list {
            background: #1E293B;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .request-item {
            background: #141A24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #F59E0B;
            transition: all 0.3s ease;
        }
        .request-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        .btn-approve { background: #10B981; color: white; }
        .btn-approve:hover { background: #059669; }
        .btn-reject { background: #EF4444; color: white; }
        .btn-reject:hover { background: #DC2626; }
        .logs {
            background: #1E293B;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .manual-section {
            background: #1E293B;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .manual-input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #2D3748;
            background: #141A24;
            color: white;
            width: 100%;
            margin: 10px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-pending { background: #F59E0B; color: white; }
        .status-approved { background: #10B981; color: white; }
        .status-rejected { background: #EF4444; color: white; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #2D3748;
            padding-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            background: #2D3748;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background: #1E293B;
        }
        .tab.active {
            background: #0088cc;
        }
        .counter {
            display: inline-block;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-left: 5px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ</a>
        <h1>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–æ–º Telegram</h1>
        
        <div style="background: rgba(0, 136, 204, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="margin: 0; color: #94A3B8;">
                <strong>–ë–æ—Ç:</strong> @UGgtavBot | 
                <strong>–ê–¥–º—ñ–Ω ID:</strong> 5316593741 | 
                <strong>–ó–∞–ø–∏—Ç—ñ–≤ –æ—á—ñ–∫—É—î:</strong> <span id="pendingCount">0</span>
            </p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('requests')" id="tabRequests">
                üìã –ó–∞–ø–∏—Ç–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø <span id="requestsCounter" class="counter">0</span>
            </button>
            <button class="tab" onclick="showTab('users')" id="tabUsers">
                üë• –í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
            </button>
            <button class="tab" onclick="showTab('manual')" id="tabManual">
                ‚úèÔ∏è –†—É—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è
            </button>
        </div>
        
        <div id="requestsTab" class="tab-content">
            <div class="requests-list" id="requestsList">
                <h3>–ó–∞–ø–∏—Ç–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø:</h3>
                <p id="noRequests">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
        </div>
        
        <div id="usersTab" class="tab-content" style="display: none;">
            <div class="requests-list" id="allUsersList">
                <h3>–í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ:</h3>
                <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
        </div>
        
        <div id="manualTab" class="tab-content" style="display: none;">
            <div class="manual-section">
                <h3>–†—É—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏:</h3>
                <input type="text" id="manualUserId" class="manual-input" placeholder="–í–≤–µ–¥—ñ—Ç—å ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞">
                <input type="text" id="manualUserName" class="manual-input" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)">
                <input type="text" id="manualUserUsername" class="manual-input" placeholder="–í–≤–µ–¥—ñ—Ç—å Telegram username (–±–µ–∑ @)">
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; color: #94A3B8;">–°—Ç–∞—Ç—É—Å:</label>
                    <select id="manualUserStatus" class="manual-input">
                        <option value="pending">‚è≥ –û—á—ñ–∫—É—î</option>
                        <option value="approved">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</option>
                        <option value="rejected">‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ</option>
                    </select>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; color: #94A3B8;">
                        <input type="checkbox" id="manualIsAdmin"> üëë –ó—Ä–æ–±–∏—Ç–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
                    </label>
                </div>
                
                <div>
                    <button class="btn btn-approve" onclick="manualSaveUser()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
                    <button class="btn btn-reject" onclick="manualDeleteUser()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
                    <button class="btn" onclick="manualClearForm()" style="background: #2D3748;">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
                </div>
            </div>
        </div>
        
        <div class="logs">
            <h4>–õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º–∏:</h4>
            <div id="logOutput"></div>
        </div>
    </div>

    <script type="module">
        import { db, ADMIN_ID } from './firebase-app.js';
        import { doc, getDoc, updateDoc, collection, query, where, getDocs, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        
        let currentTab = 'requests';
        let allUsers = [];
        
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString('uk-UA');
            const colors = { info: '#94A3B8', success: '#10B981', error: '#EF4444', warning: '#F59E0B' };
            
            logDiv.innerHTML = `<div style="color: ${colors[type]}; margin-bottom: 5px; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">[${timestamp}] ${message}</div>` + logDiv.innerHTML;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function showTab(tabName) {
            currentTab = tabName;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            if (tabName === 'users') {
                loadAllUsers();
            }
        }
        
        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const userId = params.get('user_id');
            
            addLog(`üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ URL: action=${action}, user_id=${userId}`, 'info');
            
            if (action && userId) {
                addLog(`üì± –û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: ${action} –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId}`, 'info');
                
                if (action === 'approve') {
                    const success = await approveUser(userId);
                    if (success) {
                        showNotification('‚úÖ –î–æ—Å—Ç—É–ø –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!', 'success');
                        setTimeout(() => {
                            if (window.opener) {
                                window.close();
                            }
                        }, 3000);
                    }
                } else if (action === 'reject') {
                    const success = await rejectUser(userId);
                    if (success) {
                        showNotification('‚ùå –î–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ!', 'error');
                        setTimeout(() => {
                            if (window.opener) {
                                window.close();
                            }
                        }, 3000);
                    }
                }
                
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        async function loadRequests() {
            try {
                // –ó–∞–ø—Ä–æ—Å—ã –∏–∑ access_requests
                const q1 = query(collection(db, "access_requests"), where("status", "==", "pending"));
                const snapshot1 = await getDocs(q1);
                
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º pending
                const q2 = query(collection(db, "users"), where("status", "==", "pending"));
                const snapshot2 = await getDocs(q2);
                
                const requests = [];
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º access_requests
                snapshot1.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.status === 'pending') {
                        requests.push({ 
                            id: docSnap.id, 
                            ...data,
                            source: 'access_requests'
                        });
                    }
                });
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º pending
                snapshot2.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.status === 'pending') {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                        if (!requests.find(r => r.id === docSnap.id)) {
                            requests.push({ 
                                id: docSnap.id, 
                                telegram_id: data.telegram_id || docSnap.id,
                                first_name: data.first_name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',
                                username: data.username || '',
                                status: 'pending',
                                created_at: data.created_at,
                                source: 'users'
                            });
                        }
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                const counter = document.getElementById('requestsCounter');
                if (counter) {
                    counter.textContent = requests.length;
                    counter.style.display = requests.length > 0 ? 'inline-block' : 'none';
                }
                
                document.getElementById('pendingCount').textContent = requests.length;
                
                if (requests.length === 0) {
                    document.getElementById('noRequests').innerHTML = '<span style="color: #94A3B8;">üéâ –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –¥–æ—Å—Ç—É–ø</span>';
                    return;
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                requests.sort((a, b) => {
                    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                    return dateB - dateA;
                });
                
                let html = '';
                requests.forEach((user, index) => {
                    const usernameDisplay = user.username ? `@${user.username}` : '–Ω–µ–º–∞—î';
                    const time = user.created_at ? new Date(user.created_at).toLocaleTimeString('uk-UA') : '—â–æ–π–Ω–æ';
                    const date = user.created_at ? new Date(user.created_at).toLocaleDateString('uk-UA') : '—Å—å–æ–≥–æ–¥–Ω—ñ';
                    const sourceBadge = user.source === 'access_requests' ? '<span class="status-badge status-pending" style="background: #8B5CF6;">üÜï</span>' : '';
                    
                    html += `
                        <div class="request-item" id="request-${user.id}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <p style="margin-bottom: 8px;">
                                        <strong>üë§ ${user.first_name}</strong> (${usernameDisplay}) 
                                        ${sourceBadge}
                                        <span class="status-badge status-pending">–û–ß–Ü–ö–£–Ñ</span>
                                    </p>
                                    <p style="color: #94A3B8; font-size: 0.9rem; margin-bottom: 5px;">
                                        üÜî ID: <code>${user.id}</code>
                                    </p>
                                    <p style="color: #94A3B8; font-size: 0.9rem; margin-bottom: 5px;">
                                        üìÖ ${date} ‚è∞ ${time}
                                    </p>
                                    <p style="color: #94A3B8; font-size: 0.8rem;">
                                        üìÇ –î–∂–µ—Ä–µ–ª–æ: ${user.source === 'access_requests' ? '–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Ç—ñ–≤' : '–ë–∞–∑–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤'}
                                    </p>
                                </div>
                                <div style="text-align: right;">
                                    <button class="btn btn-approve" onclick="approveUser('${user.id}', '${user.source}')">
                                        ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
                                    </button>
                                    <button class="btn btn-reject" onclick="rejectUser('${user.id}', '${user.source}')">
                                        ‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('requestsList').innerHTML = `
                    <h3>–ó–∞–ø–∏—Ç–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø (${requests.length}):</h3>
                    ${html}
                `;
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
                addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function approveUser(userId, source = 'users') {
            try {
                addLog(`‚úÖ –ù–∞–º–∞–≥–∞—î–º–æ—Å—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId}...`, 'info');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                let userData = null;
                
                if (source === 'access_requests') {
                    const requestDoc = await getDoc(doc(db, "access_requests", userId));
                    if (requestDoc.exists()) {
                        userData = requestDoc.data();
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const userDoc = await getDoc(doc(db, "users", userId));
                
                if (userDoc.exists()) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await updateDoc(doc(db, "users", userId), {
                        status: 'approved',
                        updated_at: new Date().toISOString()
                    });
                    addLog(`‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç–∞—Ç—É—Å —ñ—Å–Ω—É—é—á–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ${userId}`, 'success');
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await setDoc(doc(db, "users", userId), {
                        telegram_id: userId,
                        first_name: userData?.first_name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',
                        username: userData?.username || '',
                        status: 'approved',
                        isAdmin: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    addLog(`‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ${userId}`, 'success');
                }
                
                // –£–¥–∞–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∏–∑ access_requests –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
                try {
                    await deleteDoc(doc(db, "access_requests", userId));
                    addLog(`üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Ç –∑ access_requests: ${userId}`, 'info');
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç
                }
                
                // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –±–æ—Ç–∞
                await sendTelegramNotification(userId, 'approved', userData || { first_name: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á' });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                const requestElement = document.getElementById(`request-${userId}`);
                if (requestElement) {
                    requestElement.style.borderLeftColor = '#10B981';
                    requestElement.style.opacity = '0.5';
                    setTimeout(() => requestElement.remove(), 500);
                }
                
                addLog(`‚úÖ –î–æ—Å—Ç—É–ø –Ω–∞–¥–∞–Ω–æ –¥–ª—è ID: ${userId}`, 'success');
                showNotification('‚úÖ –î–æ—Å—Ç—É–ø –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∏ —Å–ø–∏—Å–∫–∏
                setTimeout(() => {
                    loadRequests();
                    if (currentTab === 'users') loadAllUsers();
                }, 500);
                
                return true;
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: ${error.message}`, 'error');
                showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è!', 'error');
                return false;
            }
        }
        
        async function rejectUser(userId, source = 'users') {
            try {
                addLog(`‚ùå –ù–∞–º–∞–≥–∞—î–º–æ—Å—å –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId}...`, 'info');
                
                const userDoc = await getDoc(doc(db, "users", userId));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    await updateDoc(doc(db, "users", userId), {
                        status: 'rejected',
                        updated_at: new Date().toISOString()
                    });
                    
                    // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
                    await sendTelegramNotification(userId, 'rejected', userData);
                } else {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Å —Å—Ç–∞—Ç—É—Å–æ–º rejected
                    await setDoc(doc(db, "users", userId), {
                        telegram_id: userId,
                        first_name: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',
                        username: '',
                        status: 'rejected',
                        isAdmin: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }
                
                // –£–¥–∞–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∏–∑ access_requests –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
                try {
                    await deleteDoc(doc(db, "access_requests", userId));
                    addLog(`üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Ç –∑ access_requests: ${userId}`, 'info');
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                const requestElement = document.getElementById(`request-${userId}`);
                if (requestElement) {
                    requestElement.style.borderLeftColor = '#EF4444';
                    requestElement.style.opacity = '0.5';
                    setTimeout(() => requestElement.remove(), 500);
                }
                
                addLog(`‚ùå –î–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ –¥–ª—è ID: ${userId}`, 'error');
                showNotification('‚ùå –î–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ!', 'error');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∏ —Å–ø–∏—Å–∫–∏
                setTimeout(() => {
                    loadRequests();
                    if (currentTab === 'users') loadAllUsers();
                }, 500);
                
                return true;
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è: ${error.message}`, 'error');
                showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è!', 'error');
                return false;
            }
        }
        
        async function sendTelegramNotification(userId, action, userData) {
            const BOT_TOKEN = "8506586970:AAEEhVuyML6qBI5nG3U5HlgjaN2B0pR1xeA";
            const usernameDisplay = userData.username ? `@${userData.username}` : '–Ω–µ–º–∞—î';
            
            const message = action === 'approved' 
                ? `üéâ *–î–û–°–¢–£–ü –ù–ê–î–ê–ù–û!*

üë§ *–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:* ${userData.first_name} (${usernameDisplay})
üÜî *ID:* ${userId}
‚úÖ *–°—Ç–∞—Ç—É—Å:* –î–æ—Å—Ç—É–ø –Ω–∞–¥–∞–Ω–æ

–í–∏ —Ç–µ–ø–µ—Ä –º–æ–∂–µ—Ç–µ —É–≤—ñ–π—Ç–∏ –¥–æ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ Ukraine GTA 5.

üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è: https://swetatop.github.io/manual/`
                : `üö´ *–î–û–°–¢–£–ü –í–Ü–î–•–ò–õ–ï–ù–û*

üë§ *–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:* ${userData.first_name} (${usernameDisplay})
üÜî *ID:* ${userId}
‚ùå *–°—Ç–∞—Ç—É—Å:* –î–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ

–í–∞–º –≤—ñ–¥–º–æ–≤–ª–µ–Ω–æ –≤ –¥–æ—Å—Ç—É–ø—ñ –¥–æ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ Ukraine GTA 5.`;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: userId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                const result = await response.json();
                if (result.ok) {
                    addLog(`üì§ –£–≤–µ–¥–æ–º–ª–µ–Ω–Ω—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`, 'success');
                } else {
                    addLog(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ${result.description}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }
        
        async function loadAllUsers() {
            try {
                const snapshot = await getDocs(collection(db, "users"));
                allUsers = [];
                
                snapshot.forEach(docSnap => {
                    allUsers.push({
                        id: docSnap.id,
                        ...docSnap.data()
                    });
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                allUsers.sort((a, b) => {
                    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                    return dateB - dateA;
                });
                
                let html = '';
                
                if (allUsers.length === 0) {
                    html = '<p style="color: #94A3B8;">üë• –ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤ —Å–∏—Å—Ç–µ–º—ñ</p>';
                } else {
                    html = `<h3>–í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (${allUsers.length}):</h3>`;
                    
                    allUsers.forEach(user => {
                        const statusClass = `status-${user.status || 'pending'}`;
                        const usernameDisplay = user.username ? `@${user.username}` : '–Ω–µ–º–∞—î';
                        const createdAt = user.created_at ? new Date(user.created_at).toLocaleString('uk-UA') : '–Ω–µ–≤—ñ–¥–æ–º–æ';
                        const updatedAt = user.updated_at ? new Date(user.updated_at).toLocaleString('uk-UA') : '–Ω—ñ–∫–æ–ª–∏';
                        
                        html += `
                            <div class="request-item" style="border-left-color: ${user.status === 'approved' ? '#10B981' : user.status === 'rejected' ? '#EF4444' : '#F59E0B'}" id="user-${user.id}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <p style="margin-bottom: 8px;">
                                            <strong>üë§ ${user.first_name}</strong> (${usernameDisplay}) 
                                            <span class="status-badge ${statusClass}">${user.status || 'pending'}</span>
                                            ${user.isAdmin ? '<span class="status-badge" style="background: #8B5CF6;">üëë –ê–î–ú–Ü–ù</span>' : ''}
                                        </p>
                                        <p style="color: #94A3B8; font-size: 0.9rem; margin-bottom: 5px;">
                                            üÜî ID: <code>${user.id}</code>
                                        </p>
                                        <p style="color: #94A3B8; font-size: 0.9rem; margin-bottom: 5px;">
                                            üìÖ –°—Ç–≤–æ—Ä–µ–Ω–æ: ${createdAt}
                                        </p>
                                        <p style="color: #94A3B8; font-size: 0.9rem;">
                                            üîÑ –û–Ω–æ–≤–ª–µ–Ω–æ: ${updatedAt}
                                        </p>
                                    </div>
                                    <div style="text-align: right; display: flex; flex-direction: column; gap: 5px;">
                                        <div>
                                            <button class="btn" onclick="changeUserStatus('${user.id}', 'approved')" style="background: #10B981; padding: 6px 12px; font-size: 0.9rem;">
                                                ‚úÖ
                                            </button>
                                            <button class="btn" onclick="changeUserStatus('${user.id}', 'pending')" style="background: #F59E0B; padding: 6px 12px; font-size: 0.9rem;">
                                                ‚è≥
                                            </button>
                                            <button class="btn" onclick="changeUserStatus('${user.id}', 'rejected')" style="background: #EF4444; padding: 6px 12px; font-size: 0.9rem;">
                                                ‚ùå
                                            </button>
                                        </div>
                                        <div>
                                            <button class="btn" onclick="toggleAdmin('${user.id}', ${!user.isAdmin})" style="background: #8B5CF6; padding: 6px 12px; font-size: 0.9rem;">
                                                ${user.isAdmin ? 'üëë –ó–∞–±—Ä–∞—Ç–∏' : 'üëë –î–∞—Ç–∏'}
                                            </button>
                                            <button class="btn" onclick="editUser('${user.id}')" style="background: #3B82F6; padding: 6px 12px; font-size: 0.9rem;">
                                                ‚úèÔ∏è
                                            </button>
                                            <button class="btn" onclick="deleteUser('${user.id}')" style="background: #DC2626; padding: 6px 12px; font-size: 0.9rem;">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('allUsersList').innerHTML = html;
                addLog(`üìã –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${allUsers.length} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤`, 'success');
                
            } catch (error) {
                addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: ${error.message}`, 'error');
            }
        }
        
        window.changeUserStatus = async function(userId, status) {
            try {
                await updateDoc(doc(db, "users", userId), {
                    status: status,
                    updated_at: new Date().toISOString()
                });
                
                addLog(`üìù –ó–º—ñ–Ω–µ–Ω–æ —Å—Ç–∞—Ç—É—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId} –Ω–∞ ${status}`, 'success');
                showNotification(`‚úÖ –°—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ ${status}`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                setTimeout(() => {
                    loadAllUsers();
                    loadRequests();
                }, 500);
                
            } catch (error) {
                addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É: ${error.message}`, 'error');
                showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É!', 'error');
            }
        };
        
        window.toggleAdmin = async function(userId, makeAdmin) {
            try {
                await updateDoc(doc(db, "users", userId), {
                    isAdmin: makeAdmin,
                    updated_at: new Date().toISOString()
                });
                
                addLog(`üëë ${makeAdmin ? '–ù–∞–¥–∞–Ω–æ' : '–ó–∞–±—Ä–∞–Ω–æ'} –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞ –¥–ª—è ${userId}`, 'success');
                showNotification(`‚úÖ ${makeAdmin ? '–ù–∞–¥–∞–Ω–æ' : '–ó–∞–±—Ä–∞–Ω–æ'} –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                setTimeout(() => {
                    loadAllUsers();
                    loadRequests();
                }, 500);
                
            } catch (error) {
                addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ –ø—Ä–∞–≤: ${error.message}`, 'error');
                showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ –ø—Ä–∞–≤!', 'error');
            }
        };
        
        window.editUser = function(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('manualUserId').value = user.id;
            document.getElementById('manualUserName').value = user.first_name || '';
            document.getElementById('manualUserUsername').value = user.username || '';
            document.getElementById('manualUserStatus').value = user.status || 'pending';
            document.getElementById('manualIsAdmin').checked = user.isAdmin || false;
            
            showTab('manual');
            showNotification('‚úèÔ∏è –ó–∞–ø–æ–≤–Ω–µ–Ω–æ —Ñ–æ—Ä–º—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è', 'info');
        };
        
        window.deleteUser = async function(userId) {
            if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId}? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏!`)) return;
            
            try {
                await deleteDoc(doc(db, "users", userId));
                
                // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –∏–∑ access_requests –µ—Å–ª–∏ –µ—Å—Ç—å
                try {
                    await deleteDoc(doc(db, "access_requests", userId));
                } catch (e) {}
                
                addLog(`üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId}`, 'success');
                showNotification('‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–∏–¥–∞–ª–µ–Ω–æ!', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                setTimeout(() => {
                    loadAllUsers();
                    loadRequests();
                }, 500);
                
            } catch (error) {
                addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ${error.message}`, 'error');
                showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è!', 'error');
            }
        };
        
        window.manualSaveUser = async function() {
            const userId = document.getElementById('manualUserId').value.trim();
            const userName = document.getElementById('manualUserName').value.trim() || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
            const userUsername = document.getElementById('manualUserUsername').value.trim();
            const userStatus = document.getElementById('manualUserStatus').value;
            const isAdmin = document.getElementById('manualIsAdmin').checked;
            
            if (!userId) {
                showNotification('‚ùå –í–≤–µ–¥—ñ—Ç—å ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞!', 'error');
                return;
            }
            
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                
                if (userDoc.exists()) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await updateDoc(doc(db, "users", userId), {
                        first_name: userName,
                        username: userUsername,
                        status: userStatus,
                        isAdmin: isAdmin,
                        updated_at: new Date().toISOString()
                    });
                    addLog(`‚úèÔ∏è –û–Ω–æ–≤–ª–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId}`, 'success');
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await setDoc(doc(db, "users", userId), {
                        telegram_id: userId,
                        first_name: userName,
                        username: userUsername,
                        status: userStatus,
                        isAdmin: isAdmin,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    addLog(`üÜï –°—Ç–≤–æ—Ä–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId}`, 'success');
                }
                
                showNotification('‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                setTimeout(() => {
                    loadAllUsers();
                    loadRequests();
                }, 500);
                
            } catch (error) {
                addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${error.message}`, 'error');
                showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è!', 'error');
            }
        };
        
        window.manualDeleteUser = async function() {
            const userId = document.getElementById('manualUserId').value.trim();
            
            if (!userId) {
                showNotification('‚ùå –í–≤–µ–¥—ñ—Ç—å ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è!', 'error');
                return;
            }
            
            await deleteUser(userId);
        };
        
        window.manualClearForm = function() {
            document.getElementById('manualUserId').value = '';
            document.getElementById('manualUserName').value = '';
            document.getElementById('manualUserUsername').value = '';
            document.getElementById('manualUserStatus').value = 'pending';
            document.getElementById('manualIsAdmin').checked = false;
            showNotification('üßπ –§–æ—Ä–º—É –æ—á–∏—â–µ–Ω–æ', 'info');
        };
        
        function showNotification(message, type) {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : type === 'warning' ? '#F59E0B' : '#3B82F6'};
                color: white;
            `;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <span style="font-size: 1.2rem;">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        window.approveUser = approveUser;
        window.rejectUser = rejectUser;
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        setInterval(loadRequests, 10000);
        
        window.onload = async function() {
            addLog('üöÄ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–ø—É—â–µ–Ω–∞', 'success');
            await checkUrlParams();
            await loadRequests();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadRequests, 30000);
        };
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
