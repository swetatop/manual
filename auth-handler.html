<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–û–±—Ä–æ–±–∫–∞ –≤—Ö–æ–¥—É | Ukraine GTA 5</title>
    <style>
        body { 
            background: #0f1419; 
            color: white; 
            padding: 50px; 
            text-align: center; 
            font-family: sans-serif;
        }
        .log { 
            background: #1a2029; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px auto; 
            max-width: 600px;
            text-align: left;
            word-wrap: break-word;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        button {
            background: #3390ec;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover { background: #2a7fd8; }
        .admin-btn { background: #10B981; }
        .admin-btn:hover { background: #059669; }
    </style>
</head>
<body>
    <h2>üîß –û–±—Ä–æ–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó Telegram Widget</h2>
    
    <div class="log" id="debugInfo">
        ‚è≥ –ê–Ω–∞–ª—ñ–∑—É—î–º–æ –æ—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ...
    </div>

    <div id="actionButtons" style="display: none;">
        <button onclick="approveUser()" class="admin-btn">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
        <button onclick="goToAdmin()" class="admin-btn">üëë –ü–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º—ñ–Ω–∫—É</button>
        <button onclick="goBack()">‚Ü©Ô∏è –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≤—Ö–æ–¥—É</button>
    </div>

    <script>
        // 1. –ü–ê–†–°–ò–ú–û –î–ê–ù–Ü –ó URL
        const urlParams = new URLSearchParams(window.location.search);
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –í–°–Ü –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —â–æ –Ω–∞–¥—ñ—Å–ª–∞–≤ Telegram
        const telegramData = {
            id: urlParams.get('id'),
            first_name: urlParams.get('first_name'),
            username: urlParams.get('username') || '',
            photo_url: urlParams.get('photo_url') || '',
            auth_date: urlParams.get('auth_date'),
            hash: urlParams.get('hash')
        };
        
        console.log('üì• –ü–æ–≤–Ω—ñ –¥–∞–Ω—ñ –≤—ñ–¥ Telegram Widget:', telegramData);
        
        // üî• –§–Ü–ö–° 1: –§—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥—É
        function saveAndRedirect(userData) {
            console.log('üíæ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –≤ localStorage:', userData);
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            const userToSave = {
                id: userData.id,
                first_name: userData.first_name,
                username: userData.username,
                photo_url: userData.photo_url,
                auth_date: userData.auth_date,
                hash: userData.hash
            };
            
            localStorage.setItem('telegram_user', JSON.stringify(userToSave));
            
            // –Ø–∫—â–æ —Ü–µ –∞–¥–º—ñ–Ω (—Ç–∏)
            if (userData.id === '5316593741') {
                localStorage.setItem('is_admin', 'true');
            }
            
            // –ß–∞—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
            localStorage.setItem('auth_time', Date.now().toString());
            localStorage.setItem('widget_auth', 'true');
            
            // –î–æ–¥–∞—Ç–∫–æ–≤–æ: –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
            localStorage.setItem('user_id', userData.id);
            localStorage.setItem('user_name', userData.first_name);
            
            console.log('‚úÖ –î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ localStorage:');
            console.log('- telegram_user:', localStorage.getItem('telegram_user'));
            console.log('- user_id:', localStorage.getItem('user_id'));
            console.log('- is_admin:', localStorage.getItem('is_admin'));
            
            return true;
        }
        
        // 2. –ü–û–ö–ê–ó–£–Ñ–ú–û –©–û –û–¢–†–ò–ú–ê–õ–ò
        function showDebugInfo() {
            const debug = document.getElementById('debugInfo');
            
            let html = '<strong class="success">‚úÖ –î–∞–Ω—ñ –æ—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥ Telegram:</strong><br><br>';
            html += '<strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</strong><br>';
            html += `üë§ ID: <span class="success">${telegramData.id}</span><br>`;
            html += `üìõ –Ü–º'—è: ${telegramData.first_name}<br>`;
            html += `üîó –õ–æ–≥—ñ–Ω: @${telegramData.username || '–Ω–µ–º–∞—î'}<br><br>`;
            
            html += '<strong>–¢–µ—Ö–Ω—ñ—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</strong><br>';
            html += `üìÖ –î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: ${new Date(telegramData.auth_date * 1000).toLocaleString()}<br>`;
            html += `üîê –•–µ—à: <code style="font-size: 12px;">${telegramData.hash ? telegramData.hash.substring(0, 30) + '...' : '–Ω–µ–º–∞—î'}</code><br>`;
            html += `üìé –ü–æ–≤–Ω–∏–π URL: <code style="font-size: 10px; color: #888;">${window.location.href}</code>`;
            
            debug.innerHTML = html;
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –¥—ñ–π
            document.getElementById('actionButtons').style.display = 'block';
        }
        
        // 3. –ù–ê–î–°–ò–õ–ê–Ñ–ú–û –ù–ê –°–ï–†–í–ï–† RAILWAY
        async function sendToRailway() {
            const debug = document.getElementById('debugInfo');
            
            try {
                debug.innerHTML += '<br><br>üîÑ <strong>–ù–∞–º–∞–≥–∞—î–º–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–∞ Railway...</strong>';
                
                const RAILWAY_URL = 'https://tgwebhook-production-6e8d.up.railway.app/webhook';
                
                const response = await fetch(RAILWAY_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'telegram_widget_login',
                        user: telegramData,
                        timestamp: Date.now(),
                        widget_version: '3.0'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    debug.innerHTML += `<br><span class="success">‚úÖ –£—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–∞ Railway!</span><br>`;
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                debug.innerHTML += `<br><span class="error">‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –Ω–∞ Railway:</span><br>`;
                debug.innerHTML += `${error.message}<br><br>`;
                return false;
            }
        }
        
        // 4. –ù–ê–î–°–ò–õ–ê–ù–ù–Ø –í TELEGRAM
        async function sendDirectToTelegram() {
            const BOT_TOKEN = '8506586970:AAEEhVuyML6qBI5nG3U5HlgjaN2B0pR1xeA';
            const ADMIN_ID = '5316593741';
            
            const message = `üîî <b>Telegram Widget Login</b>\n\n` +
                           `üë§ <b>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</b>\n` +
                           `‚îú ID: <code>${telegramData.id}</code>\n` +
                           `‚îú –Ü–º'—è: ${telegramData.first_name}\n` +
                           `‚îî –õ–æ–≥—ñ–Ω: @${telegramData.username || '–Ω–µ–º–∞—î'}\n\n` +
                           `üîß <b>–¢–µ—Ö–Ω—ñ—á–Ω–µ:</b>\n` +
                           `‚îú –î–∂–µ—Ä–µ–ª–æ: Telegram Widget\n` +
                           `‚îú auth_date: ${telegramData.auth_date}\n` +
                           `‚îî –•–µ—à: <code>${telegramData.hash ? telegramData.hash.substring(0, 20) + '...' : '–Ω–µ–º–∞—î'}</code>`;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: ADMIN_ID,
                        text: message,
                        parse_mode: 'HTML',
                        reply_markup: {
                            inline_keyboard: [[
                                { 
                                    text: '‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤—Ö—ñ–¥', 
                                    callback_data: `approve_widget:${telegramData.id}:${telegramData.first_name}`
                                },
                                { 
                                    text: '‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏', 
                                    callback_data: `reject_widget:${telegramData.id}`
                                }
                            ]]
                        }
                    })
                });
                
                const result = await response.json();
                if (result.ok) {
                    document.getElementById('debugInfo').innerHTML += 
                        `<br><br><span class="success">‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤ Telegram!</span><br>`;
                    return true;
                }
            } catch (error) {
                console.error('Telegram API –ø–æ–º–∏–ª–∫–∞:', error);
            }
            
            return false;
        }
        
        // 5. –ö–ù–û–ü–ö–ê "–ü–Ü–î–¢–í–ï–†–î–ò–¢–ò"
        function approveUser() {
            console.log('‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏"');
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ
            saveAndRedirect(telegramData);
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            document.getElementById('debugInfo').innerHTML += 
                '<br><br><span style="color: green; font-weight: bold;">‚úÖ –î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!</span><br>' +
                '–ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å...';
            
            // üî• –§–Ü–ö–° 2: –ú–∏—Ç—Ç—î–≤–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –±–µ–∑ –∑–∞—Ç—Ä–∏–º–∫–∏
            window.location.href = 'index.html?auth=' + Date.now();
        }
        
        // 6. –ö–ù–û–ü–ö–ê "–ü–ï–†–ï–ô–¢–ò –í –ê–î–ú–Ü–ù–ö–£"
        function goToAdmin() {
            if (telegramData.id === '5316593741') {
                saveAndRedirect(telegramData);
                document.getElementById('debugInfo').innerHTML += 
                    '<br><br><span style="color: green; font-weight: bold;">üëë –í–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä!</span><br>' +
                    '–ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ...';
                window.location.href = 'index.html?admin=' + Date.now();
            } else {
                alert('–¶—è —Ñ—É–Ω–∫—Ü—ñ—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (ID: 5316593741)');
            }
        }
        
        // 7. –ö–ù–û–ü–ö–ê "–ü–û–í–ï–†–ù–£–¢–ò–°–Ø"
        function goBack() {
            window.location.href = 'login.html';
        }
        
        // 8. –ì–õ–û–ë–ê–õ–¨–ù–ê –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø –ü–†–ò–ú–£–°–û–í–û–ì–û –ü–ï–†–ï–•–û–î–£
        window.forceRedirect = function() {
            console.log('‚ö° –ü—Ä–∏–º—É—Å–æ–≤–∏–π –ø–µ—Ä–µ—Ö—ñ–¥');
            saveAndRedirect(telegramData);
            window.location.href = 'index.html?force=' + Date.now();
        };
        
        // 9. –ó–ê–ü–£–°–ö –ü–†–û–¶–ï–°–£
        window.addEventListener('DOMContentLoaded', async () => {
            if (!telegramData.id) {
                document.getElementById('debugInfo').innerHTML = 
                    '<span class="error">‚ùå –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –≤—ñ–¥ Telegram</span>';
                return;
            }
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –¥–∞–Ω—ñ
            showDebugInfo();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–ª—è –∞–¥–º—ñ–Ω–∞
            if (telegramData.id === '5316593741') {
                document.getElementById('debugInfo').innerHTML += 
                    '<br><br><span class="success">üëë –í–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä!</span><br>' +
                    '–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –≤–∏—â–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É.';
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –∞–¥–º—ñ–Ω–∞
                saveAndRedirect(telegramData);
            }
            
            // –ù–∞–¥—Å–∏–ª–∞—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
            await sendToRailway();
            await sendDirectToTelegram();
        });
    </script>
</body>
</html>
