<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞</title>
    <style>
        body { 
            background: #0f1419; 
            color: white; 
            padding: 50px; 
            text-align: center; 
            font-family: sans-serif;
        }
        .log { 
            background: #1a2029; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px auto; 
            max-width: 600px;
            text-align: left;
            word-wrap: break-word;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        button {
            background: #3390ec;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover { background: #2a7fd8; }
    </style>
</head>
<body>
    <h2>üîß –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram Widget</h2>
    
    <div class="log" id="debugInfo">
        ‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...
    </div>

    <div id="actionButtons" style="display: none;">
        <button onclick="approveUser()">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <button onclick="goToAdmin()">üëë –ü–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É</button>
        <button onclick="goBack()">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É</button>
    </div>

    <script>
        // 1. –ü–ê–†–°–ò–ú –î–ê–ù–ù–´–ï –ò–ó URL
        const urlParams = new URLSearchParams(window.location.search);
        
        // –ü–æ–ª—É—á–∞–µ–º –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á—Ç–æ –ø—Ä–∏—Å–ª–∞–ª Telegram
        const telegramData = {
            id: urlParams.get('id'),
            first_name: urlParams.get('first_name'),
            username: urlParams.get('username') || '',
            photo_url: urlParams.get('photo_url') || '',
            auth_date: urlParams.get('auth_date'),
            hash: urlParams.get('hash')
        };
        
        console.log('üì• –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram Widget:', telegramData);
        
        // 2. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ß–¢–û –ü–û–õ–£–ß–ò–õ–ò
        function showDebugInfo() {
            const debug = document.getElementById('debugInfo');
            
            let html = '<strong>‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –æ—Ç Telegram:</strong><br><br>';
            html += '<strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>';
            html += `üë§ ID: <span class="success">${telegramData.id}</span><br>`;
            html += `üìõ –ò–º—è: ${telegramData.first_name}<br>`;
            html += `üîó –õ–æ–≥–∏–Ω: @${telegramData.username || '–Ω–µ—Ç'}<br><br>`;
            
            html += '<strong>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong><br>';
            html += `üìÖ –î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${new Date(telegramData.auth_date * 1000).toLocaleString()}<br>`;
            html += `üîê –•—ç—à: <code style="font-size: 12px;">${telegramData.hash ? telegramData.hash.substring(0, 30) + '...' : '–Ω–µ—Ç'}</code><br>`;
            html += `üìé –ü–æ–ª–Ω—ã–π URL: <code style="font-size: 10px; color: #888;">${window.location.href}</code>`;
            
            debug.innerHTML = html;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            document.getElementById('actionButtons').style.display = 'block';
        }
        
        // 3. –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ù–ê –°–ï–†–í–ï–† RAILWAY (—á–µ—Ä–µ–∑ CORS proxy)
        async function sendToRailway() {
            const debug = document.getElementById('debugInfo');
            
            try {
                debug.innerHTML += '<br><br>üîÑ <strong>–ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ Railway...</strong>';
                
                // –í–∞—à Railway URL
                const RAILWAY_URL = 'https://tgwebhook-production-6e8d.up.railway.app/webhook';
                
                // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é
                const response = await fetch(RAILWAY_URL, {
                    method: 'POST',
                    mode: 'cors', // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∂–∏–º CORS
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'telegram_widget_login',
                        user: telegramData,
                        raw_params: window.location.search.substring(1),
                        timestamp: Date.now(),
                        widget_version: '2.0'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    debug.innerHTML += `<br><span class="success">‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ Railway!</span><br>`;
                    debug.innerHTML += `–û—Ç–≤–µ—Ç: ${JSON.stringify(data)}`;
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                debug.innerHTML += `<br><span class="error">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ Railway:</span><br>`;
                debug.innerHTML += `${error.message}<br><br>`;
                
                // –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ CORS proxy
                debug.innerHTML += 'üîÑ <strong>–ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ CORS proxy...</strong>';
                
                try {
                    const PROXY_URL = 'https://api.allorigins.win/raw?url=';
                    const proxyResponse = await fetch(PROXY_URL + encodeURIComponent(RAILWAY_URL), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            type: 'telegram_widget_proxy',
                            user: telegramData,
                            via_proxy: true
                        })
                    });
                    
                    if (proxyResponse.ok) {
                        debug.innerHTML += `<br><span class="success">‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ proxy!</span>`;
                        return true;
                    }
                } catch (proxyError) {
                    debug.innerHTML += `<br><span class="error">‚ùå Proxy —Ç–æ–∂–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª</span>`;
                }
                
                return false;
            }
        }
        
        // 4. –û–¢–ü–†–ê–í–ö–ê –ù–ê–ü–†–Ø–ú–£–Æ –í TELEGRAM (fallback)
        async function sendDirectToTelegram() {
            const BOT_TOKEN = '8506586970:AAEEhVuyML6qBI5nG3U5HlgjaN2B0pR1xeA';
            const ADMIN_ID = '5316593741'; // –¢–≤–æ–π ID
            
            const message = `üîî <b>Telegram Widget Login</b>\n\n` +
                           `üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b>\n` +
                           `‚îú ID: <code>${telegramData.id}</code>\n` +
                           `‚îú –ò–º—è: ${telegramData.first_name}\n` +
                           `‚îî –õ–æ–≥–∏–Ω: @${telegramData.username || '–Ω–µ—Ç'}\n\n` +
                           `üîß <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ:</b>\n` +
                           `‚îú –ò—Å—Ç–æ—á–Ω–∏–∫: Telegram Widget\n` +
                           `‚îú auth_date: ${telegramData.auth_date}\n` +
                           `‚îî –•—ç—à: <code>${telegramData.hash ? telegramData.hash.substring(0, 20) + '...' : '–Ω–µ—Ç'}</code>`;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: ADMIN_ID,
                        text: message,
                        parse_mode: 'HTML',
                        reply_markup: {
                            inline_keyboard: [[
                                { 
                                    text: '‚úÖ –û–¥–æ–±—Ä–∏—Ç—å –≤—Ö–æ–¥', 
                                    callback_data: `approve_widget:${telegramData.id}:${telegramData.first_name}`
                                },
                                { 
                                    text: '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å', 
                                    callback_data: `reject_widget:${telegramData.id}`
                                }
                            ]]
                        }
                    })
                });
                
                const result = await response.json();
                if (result.ok) {
                    document.getElementById('debugInfo').innerHTML += 
                        `<br><br><span class="success">‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!</span><br>` +
                        `–ê–¥–º–∏–Ω –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏.`;
                    return true;
                }
            } catch (error) {
                console.error('Telegram API error:', error);
            }
            
            return false;
        }
        
        // 5. –ö–ù–û–ü–ö–ê "–û–î–û–ë–†–ò–¢–¨" (–¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è)
        function approveUser() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
            localStorage.setItem('telegram_user', JSON.stringify(telegramData));
            localStorage.setItem('auth_time', Date.now().toString());
            localStorage.setItem('user_approved', 'true');
            
            if (telegramData.id === '5316593741') {
                localStorage.setItem('is_admin', 'true');
            }
            
            document.getElementById('debugInfo').innerHTML += 
                `<br><br><span class="success">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–¥–æ–±—Ä–µ–Ω!</span><br>` +
                `–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage.`;
                
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
        }
        
        // 6. –ö–ù–û–ü–ö–ê "–ü–ï–†–ï–ô–¢–ò –í –ê–î–ú–ò–ù–ö–£"
        function goToAdmin() {
            // –ï—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω (—Ç–≤–æ–π ID) - —Å—Ä–∞–∑—É –¥–∞–µ–º –¥–æ—Å—Ç—É–ø
            if (telegramData.id === '5316593741') {
                localStorage.setItem('telegram_user', JSON.stringify(telegramData));
                localStorage.setItem('is_admin', 'true');
                localStorage.setItem('auth_time', Date.now().toString());
                
                window.location.href = 'index.html';
            } else {
                alert('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (ID: 5316593741)');
            }
        }
        
        // 7. –ö–ù–û–ü–ö–ê "–í–ï–†–ù–£–¢–¨–°–Ø"
        function goBack() {
            window.location.href = 'login.html';
        }
        
        // 8. –ó–ê–ü–£–°–ö –ü–†–û–¶–ï–°–°–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        window.addEventListener('DOMContentLoaded', async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
            if (!telegramData.id) {
                document.getElementById('debugInfo').innerHTML = 
                    '<span class="error">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram Widget</span><br>' +
                    '–í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            showDebugInfo();
            
            // 1. –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ Railway
            const railwaySuccess = await sendToRailway();
            
            // 2. –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram
            if (!railwaySuccess) {
                document.getElementById('debugInfo').innerHTML += 
                    '<br><br><span class="warning">‚ö†Ô∏è –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram...</span>';
                
                const telegramSuccess = await sendDirectToTelegram();
                
                if (!telegramSuccess) {
                    document.getElementById('debugInfo').innerHTML += 
                        '<br><span class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</span><br>' +
                        '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–û–¥–æ–±—Ä–∏—Ç—å" –Ω–∏–∂–µ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.';
                }
            }
            
            // 3. –ï—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å—Ä–∞–∑—É –≤–æ–π—Ç–∏
            if (telegramData.id === '5316593741') {
                document.getElementById('debugInfo').innerHTML += 
                    '<br><br><span class="success">üëë –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã!</span><br>' +
                    '–ú–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É.';
            }
        });
    </script>
</body>
</html>
