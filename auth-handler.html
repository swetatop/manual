<!-- Firebase -->
<script type="module" src="firebase-app.js"></script>
<script type="module">
    import { db } from './firebase-app.js';
    import { doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    const userName = params.get('user_name');
    const userLogin = params.get('user_login');
    const authDate = params.get('auth_date');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const userIdEl = document.getElementById('userId');
    const userNameEl = document.getElementById('userName');
    const userLoginEl = document.getElementById('userLogin');
    const authDateEl = document.getElementById('authDate');
    const statusBox = document.getElementById('statusBox');
    const statusText = document.getElementById('statusText');
    const buttons = document.getElementById('buttons');
    const adminInfo = document.getElementById('adminInfo');
    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    userIdEl.textContent = userId || '–ù–µ–º–∞—î';
    userNameEl.textContent = decodeURIComponent(userName || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á');
    userLoginEl.textContent = userLogin ? '@' + userLogin : '–ù–µ–º–∞—î';
    authDateEl.textContent = authDate ? 
        new Date(parseInt(authDate) * 1000).toLocaleString('uk-UA') : '–ù–µ–≤—ñ–¥–æ–º–æ';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–¥–º–∏–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    async function checkIfAdmin() {
        console.log('üëë –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞...');
        
        const savedUser = localStorage.getItem('telegram_user');
        
        if (!savedUser) {
            console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ localStorage');
            return false;
        }
        
        try {
            const userData = JSON.parse(savedUser);
            const currentUserId = userData.id;
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Ç—ã (ID: 5316593741) - –∞–¥–º–∏–Ω
            if (currentUserId === '5316593741') {
                console.log('‚úÖ –≠—Ç–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω');
                adminInfo.style.display = 'block';
                return true;
            }
            
            return false;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞:', error);
            return false;
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function checkUserStatus() {
        if (!userId) {
            showError('‚ùå –ù–µ–º–∞—î ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
            return;
        }
        
        try {
            const userDoc = await getDoc(doc(db, "users", userId));
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const status = userData.status || 'pending';
                
                updateStatus(status);
                
                // –ï—Å–ª–∏ —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω
                if (status === 'approved') {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    const userDataForStorage = {
                        id: userId,
                        first_name: decodeURIComponent(userName || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'),
                        username: userLogin || '',
                        auth_date: authDate ? parseInt(authDate) : Date.now()
                    };
                    
                    localStorage.setItem('telegram_user', JSON.stringify(userDataForStorage));
                    localStorage.setItem('auth_time', Date.now().toString());
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }
                
            } else {
                // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                await setDoc(doc(db, "users", userId), {
                    telegram_id: userId,
                    name: decodeURIComponent(userName || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'),
                    username: userLogin || '',
                    status: 'pending',
                    created_at: new Date(),
                    auth_date: authDate ? parseInt(authDate) : Date.now()
                });
                
                updateStatus('pending');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            showError('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É');
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    function updateStatus(status) {
        switch (status) {
            case 'pending':
                statusBox.className = 'status-box status-pending';
                statusText.innerHTML = '<i class="fas fa-clock"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è';
                break;
                
            case 'approved':
                statusBox.className = 'status-box status-approved';
                statusText.innerHTML = '<i class="fas fa-check-circle"></i> ‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π';
                buttons.style.display = 'none';
                break;
                
            case 'rejected':
                statusBox.className = 'status-box status-rejected';
                statusText.innerHTML = '<i class="fas fa-times-circle"></i> ‚ùå –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥—Ö–∏–ª–µ–Ω–∏–π';
                buttons.style.display = 'none';
                break;
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    function showError(message) {
        statusBox.className = 'status-box status-rejected';
        statusText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
        buttons.style.display = 'none';
    }
    
    // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function approveUser() {
        if (!userId) return;
        
        try {
            await updateDoc(doc(db, "users", userId), {
                status: 'approved',
                approved_at: new Date(),
                approved_by: 'admin_from_site'
            });
            
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω:', userId);
            
            updateStatus('approved');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = {
                id: userId,
                first_name: decodeURIComponent(userName || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'),
                username: userLogin || '',
                auth_date: authDate ? parseInt(authDate) : Date.now()
            };
            
            localStorage.setItem('telegram_user', JSON.stringify(userData));
            localStorage.setItem('auth_time', Date.now().toString());
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', error);
            alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
        }
    }
    
    // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function rejectUser() {
        if (!userId) return;
        
        if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) {
            return;
        }
        
        try {
            await updateDoc(doc(db, "users", userId), {
                status: 'rejected',
                rejected_at: new Date(),
                rejected_by: 'admin_from_site'
            });
            
            updateStatus('rejected');
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:', error);
            alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function init() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è auth-handler...');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–¥–º–∏–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const isAdmin = await checkIfAdmin();
        
        // –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await checkUserStatus();
        
        // –ï—Å–ª–∏ –∞–¥–º–∏–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        if (isAdmin) {
            adminInfo.style.display = 'block';
            approveBtn.addEventListener('click', approveUser);
            rejectBtn.addEventListener('click', rejectUser);
        } else {
            // –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω - —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            buttons.style.display = 'none';
            
            // –ù–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Å–µ–±—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç
            const savedUser = localStorage.getItem('telegram_user');
            if (savedUser) {
                const currentUser = JSON.parse(savedUser);
                if (currentUser.id === userId) {
                    console.log('‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å');
                    // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–∞—à –∑–∞–ø—Ä–æ—Å –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
                }
            }
        }
        
        console.log('‚úÖ Auth-handler –≥–æ—Ç–æ–≤');
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º
    document.addEventListener('DOMContentLoaded', init);
</script>
