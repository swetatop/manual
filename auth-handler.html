<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—Ä–æ–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó | Ukraine GTA 5</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0C1016;
            color: white;
            font-family: sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        .container { max-width: 500px; width: 100%; }
        .spinner {
            border: 4px solid rgba(0, 136, 204, 0.1);
            border-top: 4px solid #0088cc;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
            text-decoration: none;
            display: inline-block;
        }
        .user-info {
            background: rgba(0, 136, 204, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        .error { color: #EF4444; }
        .success { color: #10B981; }
        .warning { color: #F59E0B; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: #0088cc; margin-bottom: 20px;">Ukraine GTA 5</h1>
        <div id="content">
            <div class="spinner"></div>
            <h3>–û–±—Ä–æ–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...</h3>
            <p>–ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞</p>
        </div>
    </div>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <script>
        // === –ù–ê–°–¢–†–û–ô–ö–ò ===
        const BOT_TOKEN = "8506586970:AAEEhVuyML6qBI5nG3U5HlgjaN2B0pR1xeA";
        const ADMIN_ID = "5316593741";
        
        // === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
        async function processAuth() {
            console.log('=== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ù–ê–ß–ê–¢–ê ===');
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL
            const userData = getDataFromURL();
            
            if (userData && userData.id) {
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', userData);
                await handleUser(userData);
            } else {
                console.log('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã');
                showError('–î–∞–Ω—ñ –Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥ Telegram');
            }
        }
        
        // === –ü–û–õ–£–ß–ò–¢–¨ –î–ê–ù–ù–´–ï –ò–ó URL ===
        function getDataFromURL() {
            try {
                // Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ hash (#id=...)
                if (window.location.hash) {
                    const hash = window.location.hash.substring(1);
                    const params = new URLSearchParams(hash);
                    
                    const userData = {
                        id: params.get('id'),
                        first_name: params.get('first_name'),
                        username: params.get('username'),
                        photo_url: params.get('photo_url'),
                        auth_date: params.get('auth_date'),
                        hash: params.get('hash')
                    };
                    
                    if (userData.id) {
                        return userData;
                    }
                }
                
                // –ò–ª–∏ –∏–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                
                if (id) {
                    return {
                        id: id,
                        first_name: params.get('first_name') || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',
                        username: params.get('username') || '',
                        auth_date: params.get('auth_date') || Math.floor(Date.now() / 1000)
                    };
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
            }
            
            return null;
        }
        
        // === –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===
        async function handleUser(userData) {
            showMessage(`
                <h2>üëã –í—ñ—Ç–∞—î–º–æ, ${userData.first_name}!</h2>
                <div class="user-info">
                    <p><strong>ID:</strong> ${userData.id}</p>
                    <p><strong>Username:</strong> ${userData.username ? '@' + userData.username : '–Ω–µ–º–∞—î'}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø...</p>
                </div>
                <div class="spinner"></div>
            `);
            
            // –ï—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω - —Å—Ä–∞–∑—É –¥–∞–µ–º –¥–æ—Å—Ç—É–ø
            if (userData.id === ADMIN_ID) {
                console.log('‚úÖ –≠—Ç–æ –∞–¥–º–∏–Ω, –¥–∞–µ–º –¥–æ—Å—Ç—É–ø');
                await saveUserToFirebase(userData, true);
                grantAccess(userData, true);
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ Firebase
            await checkFirebaseAccess(userData);
        }
        
        // === –°–û–•–†–ê–ù–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í FIREBASE ===
        async function saveUserToFirebase(userData, isAdmin = false) {
            if (typeof db === 'undefined') {
                console.error('Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return false;
            }
            
            try {
                const userDoc = {
                    telegram_id: userData.id,
                    first_name: userData.first_name,
                    username: userData.username || '',
                    photo_url: userData.photo_url || '',
                    isAdmin: isAdmin,
                    status: isAdmin ? 'approved' : 'pending',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                await db.collection("users").doc(userData.id).set(userDoc, { merge: true });
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase');
                
                // –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∞–¥–º–∏–Ω—É
                if (!isAdmin) {
                    await sendRequestToAdmin(userData);
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                return false;
            }
        }
        
        // === –ü–†–û–í–ï–†–ò–¢–¨ –î–û–°–¢–£–ü –í FIREBASE ===
        async function checkFirebaseAccess(userData) {
            if (typeof db === 'undefined') {
                showError('Firebase –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                return;
            }
            
            try {
                const docRef = db.collection("users").doc(userData.id);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const userDoc = doc.data();
                    console.log('–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', userDoc);
                    
                    if (userDoc.status === 'approved') {
                        // –î–æ—Å—Ç—É–ø —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
                        grantAccess(userData, false);
                        return;
                    } else if (userDoc.status === 'rejected') {
                        // –î–æ—Å—Ç—É–ø –æ—Ç–∫–ª–æ–Ω–µ–Ω
                        showMessage(`
                            <h2 class="error">‚ùå –î–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ</h2>
                            <p>–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ñ–¥—Ö–∏–ª–∏–≤ –≤–∞—à –∑–∞–ø–∏—Ç –Ω–∞ –¥–æ—Å—Ç—É–ø.</p>
                            <a href="login.html" class="btn">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è</a>
                        `);
                        return;
                    } else if (userDoc.status === 'pending') {
                        // –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                        showWaitingScreen(userData);
                        startFirebaseListener(userData.id);
                        return;
                    }
                }
                
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å
                await saveUserToFirebase(userData, false);
                showWaitingScreen(userData);
                startFirebaseListener(userData.id);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞:', error);
                showError('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø—É');
            }
        }
        
        // === –û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–ü–†–û–° –ê–î–ú–ò–ù–£ ===
        async function sendRequestToAdmin(userData) {
            const usernameDisplay = userData.username 
                ? `@${userData.username}` 
                : '–Ω–µ–º–∞—î';
            
            const message = `üîî *–ù–û–í–ò–ô –ó–ê–ü–ò–¢ –î–û–°–¢–£–ü–£*

üë§ *–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:* ${userData.first_name} (${usernameDisplay})
üÜî *ID:* ${userData.id}
‚è∞ *–ß–∞—Å:* ${new Date().toLocaleTimeString('uk-UA')}

*–ù–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ Ukraine GTA 5?*`;
            
            try {
                // –°—Å—ã–ª–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                const approveUrl = `https://swetatop.github.io/manual/bot-handler.html?action=approve&user_id=${userData.id}`;
                const rejectUrl = `https://swetatop.github.io/manual/bot-handler.html?action=reject&user_id=${userData.id}`;
                
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: ADMIN_ID,
                        text: message,
                        parse_mode: 'Markdown',
                        reply_markup: {
                            inline_keyboard: [[
                                { 
                                    text: "‚úÖ –ü–Ü–î–¢–í–ï–†–î–ò–¢–ò", 
                                    url: approveUrl
                                },
                                { 
                                    text: "‚ùå –í–Ü–î–•–ò–õ–ò–¢–ò", 
                                    url: rejectUrl
                                }
                            ]]
                        }
                    })
                });
                
                const result = await response.json();
                console.log('–û—Ç–≤–µ—Ç Telegram API:', result);
                
                if (!result.ok) {
                    console.error('Telegram API –æ—à–∏–±–∫–∞:', result.description);
                    return false;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Firebase
                if (typeof db !== 'undefined') {
                    const requestData = {
                        user_id: userData.id,
                        user_name: userData.first_name,
                        username: userData.username || '',
                        status: 'pending',
                        created_at: new Date().toISOString()
                    };
                    
                    await db.collection("access_requests").doc(userData.id).set(requestData);
                }
                
                return true;
                
            } catch (error) {
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:', error);
                return false;
            }
        }
        
        // === –≠–ö–†–ê–ù –û–ñ–ò–î–ê–ù–ò–Ø ===
        function showWaitingScreen(userData) {
            const usernameDisplay = userData.username 
                ? `@${userData.username}` 
                : '–Ω–µ–º–∞—î';
            
            showMessage(`
                <h2 class="warning">‚è≥ –û—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h2>
                <p>–ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É</p>
                
                <div class="user-info">
                    <p><strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</strong> ${userData.first_name} (${usernameDisplay})</p>
                    <p><strong>ID:</strong> ${userData.id}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –û—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è...</p>
                </div>
                
                <div style="margin: 30px;">
                    <div style="display: inline-block; width: 12px; height: 12px; background: #0088cc; border-radius: 50%; margin: 0 5px; animation: pulse 1s infinite;"></div>
                    <div style="display: inline-block; width: 12px; height: 12px; background: #0088cc; border-radius: 50%; margin: 0 5px; animation: pulse 1s infinite 0.2s;"></div>
                    <div style="display: inline-block; width: 12px; height: 12px; background: #0088cc; border-radius: 50%; margin: 0 5px; animation: pulse 1s infinite 0.4s;"></div>
                </div>
                
                <style>
                    @keyframes pulse {
                        0%, 100% { opacity: 0.2; transform: scale(0.8); }
                        50% { opacity: 1; transform: scale(1.1); }
                    }
                </style>
                
                <p style="color: #94A3B8; font-size: 0.9rem;">
                    –ê–¥–º—ñ–Ω –æ—Ç—Ä–∏–º–∞–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram –±–æ—Ç<br>
                    –ü—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –¥–æ—Å—Ç—É–ø
                </p>
                
                <button class="btn" onclick="checkStatusManually('${userData.id}')" style="margin-top: 20px;">
                    üîÑ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
                </button>
            `);
        }
        
        // === REAL-TIME –ü–†–û–°–õ–£–®–ò–í–ê–¢–ï–õ–¨ FIREBASE ===
        function startFirebaseListener(userId) {
            if (typeof db === 'undefined') return;
            
            console.log('üéß –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Firebase –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
            
            const unsubscribe = db.collection("users").doc(userId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:', userData.status);
                        
                        if (userData.status === 'approved') {
                            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
                            unsubscribe();
                            
                            const userInfo = {
                                id: userId,
                                first_name: userData.first_name,
                                username: userData.username || ''
                            };
                            
                            grantAccess(userInfo, false);
                        } else if (userData.status === 'rejected') {
                            unsubscribe();
                            showMessage(`
                                <h2 class="error">‚ùå –î–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ</h2>
                                <p>–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ñ–¥—Ö–∏–ª–∏–≤ –≤–∞—à –∑–∞–ø–∏—Ç –Ω–∞ –¥–æ—Å—Ç—É–ø.</p>
                                <a href="login.html" class="btn">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è</a>
                            `);
                        }
                    }
                }, (error) => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è:', error);
                });
                
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–ø–∏—Å–∫—É –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
            window.firebaseUnsubscribe = unsubscribe;
        }
        
        // === –†–£–ß–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê ===
        async function checkStatusManually(userId) {
            if (typeof db === 'undefined') {
                alert('Firebase –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                return;
            }
            
            try {
                const docRef = db.collection("users").doc(userId);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const userData = doc.data();
                    alert(`–°—Ç–∞—Ç—É—Å: ${userData.status || '–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'}`);
                } else {
                    alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É');
            }
        }
        
        // === –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –î–û–°–¢–£–ü ===
        function grantAccess(userData, isAdmin) {
            console.log('üéâ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø:', userData);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ sessionStorage
            sessionStorage.setItem('user_id', userData.id);
            sessionStorage.setItem('user_name', userData.first_name);
            sessionStorage.setItem('user_username', userData.username || '');
            sessionStorage.setItem('is_admin', isAdmin ? 'true' : 'false');
            
            showMessage(`
                <h2 class="success">‚úÖ –î–æ—Å—Ç—É–ø –Ω–∞–¥–∞–Ω–æ!</h2>
                <p>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –¥–æ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ...</p>
                <div class="spinner"></div>
            `);
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }
        
        // === –ü–û–ö–ê–ó–ê–¢–¨ –û–®–ò–ë–ö–£ ===
        function showError(message) {
            showMessage(`
                <h2 class="error">üòï –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó</h2>
                <p>${message}</p>
                
                <p style="color: #94A3B8; margin: 20px 0;">
                    <strong>–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:</strong><br>
                    1. Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–≤ –¥–∞–Ω—ñ<br>
                    2. –ü—Ä–æ–±–ª–µ–º–∞ –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º<br>
                    3. –í–∏ —Å–∫–∞—Å—É–≤–∞–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é
                </p>
                
                <a href="login.html" class="btn">‚Üê –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</a>
                <button class="btn" style="background: #F59E0B;" onclick="demoLogin()">
                    –î–µ–º–æ –≤—Ö—ñ–¥ (–∞–¥–º—ñ–Ω)
                </button>
            `);
        }
        
        // === –ü–û–ö–ê–ó–ê–¢–¨ –°–û–û–ë–©–ï–ù–ò–ï ===
        function showMessage(html) {
            document.getElementById('content').innerHTML = html;
        }
        
        // === –î–ï–ú–û –í–•–û–î ===
        function demoLogin() {
            const adminData = {
                id: ADMIN_ID,
                first_name: "Perets",
                username: "swetatopp"
            };
            
            grantAccess(adminData, true);
        }
        
        // === –ó–ê–ü–£–°–ö ===
        window.onload = function() {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É');
            processAuth();
        };
        
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (window.firebaseUnsubscribe) {
                window.firebaseUnsubscribe();
            }
        });
    </script>
</body>
</html>
