<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Обработка входа</title>
    <script>
        // 1. Получаем данные из URL (то, что присылает Telegram Widget)
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        
        const userData = {
            id: params.get('id'),
            first_name: params.get('first_name'),
            username: params.get('username') || 'no_username'
        };
        
        console.log('Данные от Telegram:', userData);
        
        // 2. ПРОСТО ПЕРЕСЫЛАЕМ на сервер Railway как было раньше
        // Не проверяем хэш, просто доверяем что данные пришли от виджета
        fetch('https://tgwebhook-production-6e8d.up.railway.app/webhook', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: 'telegram_widget_login',
                user: userData,
                timestamp: Date.now(),
                source: 'widget',
                raw_hash: hash // отправляем хэш как есть, если нужно
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Ответ сервера:', data);
            
            if (data.success) {
                // Сохраняем в localStorage как было
                localStorage.setItem('telegram_user', JSON.stringify(userData));
                localStorage.setItem('auth_time', Date.now().toString());
                
                // Переходим на главную
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } else {
                document.body.innerHTML = '<h1>Ошибка: ' + (data.error || 'Неизвестная ошибка') + '</h1>';
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            document.body.innerHTML = '<h1>Ошибка связи с сервером</h1>';
        });
    </script>
</head>
<body>
    <h2>Обработка авторизации...</h2>
</body>
</html>
