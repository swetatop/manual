<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Підтвердження | Ukraine GTA 5</title>
    <style>
        body {
            background: #0f1419;
            color: white;
            font-family: sans-serif;
            padding: 50px 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: #1a2029;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #2D3748;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .user-info div {
            margin: 10px 0;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .approve {
            background: #10B981;
            color: white;
        }
        
        .reject {
            background: #EF4444;
            color: white;
        }
        
        .approve:hover, .reject:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .pending {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #F59E0B;
            color: #F59E0B;
        }
        
        .approved {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10B981;
            color: #10B981;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Підтвердження користувача</h1>
        
        <div class="user-info">
            <div><strong>ID:</strong> <span id="userId">...</span></div>
            <div><strong>Ім'я:</strong> <span id="userName">...</span></div>
            <div><strong>Дата:</strong> <span id="authDate">...</span></div>
        </div>
        
        <div id="status" class="status pending">
            Користувач очікує підтвердження
        </div>
        
        <div id="buttons" class="buttons">
            <button class="approve" id="approveBtn">✅ Підтвердити</button>
            <button class="reject" id="rejectBtn">❌ Відхилити</button>
        </div>
    </div>
    
    <!-- Firebase -->
    <script type="module" src="firebase-app.js"></script>
    <script type="module">
        import { db } from './firebase-app.js';
        import { doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        
        // Получаем данные из URL
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user_id');
        const userName = params.get('user_name');
        const authDate = params.get('auth_date');
        
        // Показываем данные
        document.getElementById('userId').textContent = userId || 'Немає';
        document.getElementById('userName').textContent = decodeURIComponent(userName || 'Користувач');
        document.getElementById('authDate').textContent = authDate ? 
            new Date(parseInt(authDate) * 1000).toLocaleString('uk-UA') : 'Невідомо';
        
        // Проверяем статус пользователя
        async function checkStatus() {
            if (!userId) return;
            
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    if (userData.status === 'approved') {
                        // Уже подтверждён
                        document.getElementById('status').className = 'status approved';
                        document.getElementById('status').textContent = '✅ Користувач вже підтверджений';
                        document.getElementById('buttons').style.display = 'none';
                        
                        // Автоматически перенаправляем
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                        return;
                    }
                } else {
                    // Новый пользователь - сохраняем
                    await setDoc(doc(db, "users", userId), {
                        telegram_id: userId,
                        name: decodeURIComponent(userName || 'Користувач'),
                        status: 'pending',
                        created_at: new Date(),
                        auth_date: authDate ? parseInt(authDate) : Date.now()
                    });
                }
                
            } catch (error) {
                console.error('Помилка:', error);
            }
        }
        
        // Кнопка подтверждения
        document.getElementById('approveBtn').addEventListener('click', async function() {
            if (!userId) return;
            
            try {
                await updateDoc(doc(db, "users", userId), {
                    status: 'approved',
                    approved_at: new Date()
                });
                
                document.getElementById('status').className = 'status approved';
                document.getElementById('status').textContent = '✅ Користувач підтверджений!';
                document.getElementById('buttons').style.display = 'none';
                
                // Сохраняем в localStorage пользователя
                const userData = {
                    id: userId,
                    first_name: decodeURIComponent(userName || 'Користувач'),
                    auth_date: authDate ? parseInt(authDate) : Date.now()
                };
                
                localStorage.setItem('telegram_user', JSON.stringify(userData));
                localStorage.setItem('auth_time', Date.now().toString());
                
                // Перенаправляем через 2 секунды
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Помилка:', error);
                alert('❌ Не вдалося підтвердити');
            }
        });
        
        // Кнопка отклонения
        document.getElementById('rejectBtn').addEventListener('click', async function() {
            if (!confirm('Відхилити користувача?')) return;
            
            try {
                await updateDoc(doc(db, "users", userId), {
                    status: 'rejected',
                    rejected_at: new Date()
                });
                
                document.getElementById('status').className = 'status';
                document.getElementById('status').textContent = '❌ Користувач відхилений';
                document.getElementById('status').style.background = 'rgba(239, 68, 68, 0.1)';
                document.getElementById('status').style.border = '1px solid #EF4444';
                document.getElementById('status').style.color = '#EF4444';
                document.getElementById('buttons').style.display = 'none';
                
            } catch (error) {
                console.error('Помилка:', error);
                alert('❌ Не вдалося відхилити');
            }
        });
        
        // Проверяем при загрузке
        document.addEventListener('DOMContentLoaded', checkStatus);
    </script>
</body>
</html>
