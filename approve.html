<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É | Ukraine GTA 5</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0C1016;
            color: white;
            font-family: sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        .container { max-width: 500px; width: 100%; }
        .spinner {
            border: 4px solid rgba(0, 136, 204, 0.1);
            border-top: 4px solid #0088cc;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .success { color: #10B981; }
        .error { color: #EF4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: #0088cc; margin-bottom: 20px;">Ukraine GTA 5</h1>
        <div id="content">
            <div class="spinner"></div>
            <h3>–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É...</h3>
        </div>
    </div>

    <script type="module">
        import { db, ADMIN_ID, BOT_TOKEN } from './firebase-app.js';
        import { doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');
        const userId = urlParams.get('userId');
        const userName = urlParams.get('userName');
        const isTest = urlParams.get('test') === 'true';
        
        console.log('üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', { action, userId, userName, isTest });
        
        async function processRequest() {
            if (!action || !userId) {
                showError('–ù–µ–≤—ñ—Ä–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–∞–ø–∏—Ç—É');
                return;
            }
            
            try {
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase
                await updateDoc(doc(db, "users", userId), {
                    status: action === 'approve' ? 'approved' : 'rejected',
                    updated_at: new Date().toISOString(),
                    reviewed_by: 'admin',
                    reviewed_at: new Date().toISOString()
                });
                
                console.log(`‚úÖ Firebase –æ–±–Ω–æ–≤–ª–µ–Ω: ${userId} -> ${action}`);
                
                // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –≤ Telegram
                try {
                    const userDoc = await getDoc(doc(db, "users", userId));
                    const userData = userDoc.data();
                    
                    const statusText = action === 'approve' ? '‚úÖ –î–û–°–¢–£–ü –ù–ê–î–ê–ù–û' : '‚ùå –î–û–°–¢–£–ü –í–Ü–î–•–ò–õ–ï–ù–û';
                    const message = `${statusText}\n\nüë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${userName || userData?.first_name || userId}\nüÜî ID: ${userId}\n‚è∞ –ß–∞—Å: ${new Date().toLocaleTimeString('uk-UA')}\n\nüìä –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å.`;
                    
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: ADMIN_ID,
                            text: message,
                            parse_mode: 'Markdown'
                        })
                    });
                    
                } catch (telegramError) {
                    console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É:', telegramError.message);
                }
                
                // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                if (action === 'approve') {
                    document.getElementById('content').innerHTML = `
                        <h2 class="success">‚úÖ –î–æ—Å—Ç—É–ø –Ω–∞–¥–∞–Ω–æ!</h2>
                        <p>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—É <strong>${userName || userId}</strong> –Ω–∞–¥–∞–Ω–æ –¥–æ—Å—Ç—É–ø –¥–æ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ.</p>
                        <p>–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—ñ.</p>
                        <p style="color: #94A3B8; margin-top: 20px;">
                            –°—Ç–æ—Ä—ñ–Ω–∫–∞ –∑–∞–∫—Ä–∏—î—Ç—å—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏...
                        </p>
                    `;
                } else {
                    document.getElementById('content').innerHTML = `
                        <h2 class="error">‚ùå –î–æ—Å—Ç—É–ø –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ</h2>
                        <p>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—É <strong>${userName || userId}</strong> –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ –¥–æ—Å—Ç—É–ø.</p>
                        <p>–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—ñ.</p>
                        <p style="color: #94A3B8; margin-top: 20px;">
                            –°—Ç–æ—Ä—ñ–Ω–∫–∞ –∑–∞–∫—Ä–∏—î—Ç—å—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏...
                        </p>
                    `;
                }
                
                // 4. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.close();
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                showError(`–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏: ${error.message}`);
            }
        }
        
        function showError(message) {
            document.getElementById('content').innerHTML = `
                <h2 class="error">‚ùå –ü–æ–º–∏–ª–∫–∞</h2>
                <p>${message}</p>
                <button onclick="window.close()" style="
                    background: #0088cc;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 20px;
                ">–ó–∞–∫—Ä–∏—Ç–∏</button>
            `;
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
        document.addEventListener('DOMContentLoaded', processRequest);
    </script>
</body>
</html>
